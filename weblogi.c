  #include <sys/socket.h>
  #include <sys/types.h>
  #include <netinet/in.h>
  #include <netdb.h>
  #include <stdio.h>
  #include <string.h>
  #include <stdlib.h>
  #include <unistd.h>
  #include <errno.h>
  #include <arpa/inet.h> 
  #include "defs.h"
  #include "sock.h"
  #include "init.h"

  #define CLOG_MAIN
  #include "clog.h"
 
 const int MY_LOGGER = 0; /* Unique identifier for logger */
 
 int sock_send_command=0;
 int   port_pppx; 
 int   port_collecteur; 
 char* ip_collecteur; 
 char* ip_pppx;
 char* ip_meuble;
 int   port_meuble;
 

/*	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
      //  "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
      //  "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
      //  "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
      //  "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
      //  "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	

       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",

       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"

       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
      //  "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
	"#E00014A13A000000001ZZ;",
	
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
	"#E00014A13A000000001ZZ;",
	"#E00015A13A000000001ZZ;",
        "#E05001A13A000000001005A13A000000001006A13A000000001009A13A000000001010A13A000000001011;"
	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
	"#E00014A13A000000001ZZ;",
	"#E00015A13A000000001ZZ;",
	
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
	"#E00014A13A000000001ZZ;",
	"#E00015A13A000000001ZZ;",
	"#E00016A13A000000001ZZ;",
	
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
	"#E00014A13A000000001ZZ;",
	"#E00015A13A000000001ZZ;",
	"#E00016A13A000000001ZZ;",
	"#E00017A13A000000001ZZ;",
	
        "#E00000E73A000000001ZZ;",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
	"#E00014A13A000000001ZZ;",
	"#E00015A13A000000001ZZ;",
	"#E00016A13A000000001ZZ;",
	"#E00017A13A000000001ZZ;",
	"#E00018A13A000000001ZZ;",
	
       // "SIGNEDEVIE",
       // "SIGNEDEVIE",
       // "SIGNEDEVIE",
        "#E00000E73A000000001ZZ;",
	"#E00009A13A000000001ZZ;",
	"#E00008A13A000000001ZZ;",
	"#E00007A13A000000001ZZ;",
	"#E00006A13A000000001ZZ;",
	"#E00005A13A000000001ZZ;",
	"#E00004A13A000000001ZZ;",
	"#E00003A13A000000001ZZ;",
	"#E00002A13A000000001ZZ;",
	"#E00001A13A000000001ZZ;",
	"#E00010A13A000000001ZZ;",
	"#E00011A13A000000001ZZ;",
	"#E00012A13A000000001ZZ;",
	"#E00013A13A000000001ZZ;",
	"#E00014A13A000000001ZZ;",
	"#E00015A13A000000001ZZ;",
	"#E00016A13A000000001ZZ;",
	"#E00017A13A000000001ZZ;",
	"#E00018A13A000000001ZZ;",
	"#E00019A13A000000001ZZ;",
	"#E00020A13A000000001ZZ;"
  };
*/
 
const char* scenario[]={
	"#E00008A13A000000001ZZ;",
        "#E00001A23A000000001ZZ;",
	"#E00004A33A000000001ZZ;",
        "#E00002A43A000000001ZZ;",
        "#E00007A23A000000001ZZ;",
        "#E00009A33A000000001ZZ;",
        "#E00003A13A000000001ZZ;",
        "#E00006A23A000000001ZZ;",
        "#E00005A13A000000001ZZ;"
  };

  int _index=0;
  int nb_case=sizeof(scenario)/sizeof(scenario[0]);

  char message[BUFFER_SENT];  //20 messages max + message extinction
  char header_message[BUFFER_SENT];

  int main(int argc, char *argv[])
{
    int r=0;
    /* Initialize the logger */
    r = clog_init_path(MY_LOGGER, "weblogi_log.txt");
    if (r != 0) {
        fprintf(stderr, "Logger initialization failed.\n");
        return NULL;
    }
    /* Set minimum log level to info (default: debug) */
   clog_set_level(MY_LOGGER, CLOG_INFO);
   //clog_info(CLOG(MY_LOGGER),"Thread listener-command créé avec succés");
    int sockfd = 0, n = 0;
    char recvBuff[ACK_SIZE];
    struct sockaddr_in serv_addr; 

    ip_collecteur=init_collecteur(&ip_pppx,&port_pppx,&port_collecteur);
    char* serverName="COLLECTEUR";
    while(init_sock_client(&sock_send_command,ip_collecteur,port_collecteur,serverName)<0)
    {
   	fprintf(stderr,"Erreur création de socket client sur le port :%d",port_collecteur);
	sleep(T_CON);  
    }

    

    clog_info(CLOG(MY_LOGGER),"Connexion au serveur '%s' sur le port %d  réussie",serverName,port_collecteur);
    clog_info(CLOG(MY_LOGGER),"nombre de commandes à émettre en boucle : %d",nb_case);
    
    while(1)
    {
    	int size_message=0; 
        size_message=strlen(scenario[_index]);
        memset(message,'\0',size_message); 
        sprintf(message,"%s",scenario[_index]);


	if ((send(sock_send_command,message, size_message,0))== -1) {
            fprintf(stderr,"Echec d'envoi du message '%s'",message);
	    exit(1);
    	}
    	else {
	    clog_info(CLOG(MY_LOGGER),"WL ===> '%s'[_index:%d]",message,_index++);
    	}

	//sleep(T_READ);
    	memset(recvBuff, '0',2*ACK_SIZE);
    	n = read(sock_send_command, recvBuff,2*ACK_SIZE );
        recvBuff[n] = '\0';
	clog_info(CLOG(MY_LOGGER),"'%s'<=== COLLECTEUR",recvBuff);

    	if(n < 0)
    	{
        	fprintf(stderr,"Erreur de lecture");
    	}

        
	if (_index >= nb_case)
       	    _index = 0;

	//sleep(T_SEND);
    }
    close(sockfd);

    return 0;
 }
